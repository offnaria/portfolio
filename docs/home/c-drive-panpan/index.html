<!DOCTYPE html>
<html lang="ja">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>offNaria&#39;s Homepage</title>
<meta name="description" content="offNariaのホームページ，ポートフォリオ">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://offnaria.github.io/portfolio/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://offnaria.github.io/portfolio/css/font-awesome.min.css">
<link rel="stylesheet" href="https://offnaria.github.io/portfolio/css/owl.carousel.css">
<link rel="stylesheet" href="https://offnaria.github.io/portfolio/css/owl.theme.css">


  <link href="https://offnaria.github.io/portfolio/css/style.red.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://offnaria.github.io/portfolio/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://offnaria.github.io/portfolio/img/favicon.png">






<meta property="og:title" content="WSLがCドライブを圧迫していたので移動した" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://offnaria.github.io/portfolio/home/c-drive-panpan/" /><meta property="article:section" content="home" />
<meta property="article:published_time" content="2021-04-28T20:12:04&#43;09:00" />
<meta property="article:modified_time" content="2021-04-28T20:12:04&#43;09:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="WSLがCドライブを圧迫していたので移動した"/>
<meta name="twitter:description" content=""/>

</head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="https://offnaria.github.io/portfolio/">offNaria&#39;s Homepage</a></h1>
    
      <p class="sidebar-p">東京工業大学で情報工学を学んでいます．</p>
    
      <p class="sidebar-p">並行コンピューティングやコンピュータアーキテクチャに興味があります．</p>
    
    <ul class="sidebar-menu">
      
        <li><a href="https://offnaria.github.io/portfolio/home/">Home</a></li>
      
        <li><a href="https://offnaria.github.io/portfolio/about/">About</a></li>
      
        <li><a href="https://offnaria.github.io/portfolio/contact/">Get in touch</a></li>
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/YMD_Glasses" data-animate-hover="pulse" class="external twitter">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://www.instagram.com/ymd_spectacles/" title="" class="external instagram">
    <i class="fa fa-instagram"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/offnaria" data-animate-hover="pulse" class="external">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://www.youtube.com/channel/UCzWNynh1ChlHwoxE7Qmz_5A" data-animate-hover="pulse" class="external">
    <i class="fa fa-youtube"></i>
  </a>
  
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2021 offNaria |
        
        Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://offnaria.github.io/portfolio/">offNaria&#39;s Homepage</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         <h1>WSLがCドライブを圧迫していたので移動した</h1>
         <h4 id="経緯">経緯</h4>
<p>最近，メインPC（ゲーミング彼女）のCドライブの容量がみるみる少なくなっていくのに頭を抱えていた．250GBのSSD上に作成されたパーティションであり，個人フォルダの類はすべて他のストレージ（2TBのHDD）に移している．</p>
<p>使っていたストレージが250GBともともと少なかったわけであるが，かといっていきなり新しい大容量ストレージに換装しOSごと再インストールなんてこともできなかったため，ドライブを圧迫している犯人を突き止め可能であれば移動するという処置を取ることにした．</p>
<p>ちなみに，使っているストレージはSamsungの970 EVO Plus 250GB．</p>
<!-- raw HTML omitted -->
<p>Adobe製品のキャッシュ等々を消した時点での残り容量は17.2GBだった．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/c-red.jpg" alt="残り17.2GB"></p>
<p>人力での犯人捜しは不可能なので，<a href="https://www.vector.co.jp/soft/winnt/util/se475617.html">DiskInfo</a>というアプリケーションを使ってCドライブのルートから辿っていくと，ある一つのファイルに辿り着いた．</p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">Cの容量足りなくてAdobeのキャッシュとか全消ししてもぜんぜん変わらんから頭抱えてたけど，どうやらWSLがデカすぎるっポイ <a href="https://t.co/U6GoKRqkGs">pic.twitter.com/U6GoKRqkGs</a></p>&mdash; Y.M.D オフライン (@YMD_Glasses) <a href="https://twitter.com/YMD_Glasses/status/1387328569953554434?ref_src=twsrc%5Etfw">April 28, 2021</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>それは，WSL（Windows Subsystem for Linux）によって作成される仮想ハードディスクファイル<code>ext4.vhdx</code>であった．250GBのうちの54.2GBとはなんたることか．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/vhdx.jpg" alt="仮想ハードディスクファイル"></p>
<p>というわけで，WSLのファイルを他のドライブに移せないか調べてみたところ，いくつかのサイトでその方法が紹介されていた．とくに有用だったのが<a href="https://www.aise.ics.saitama-u.ac.jp/~gotoh/HowToReplaceWSL.html">このサイト</a>である．</p>
<p>以下，WSLの移行手順を示す．</p>
<h4 id="手法">手法</h4>
<p>WSLが実行中だとさすがに移行は不可能なので，停止し，確認する．</p>
<pre><code>&gt; wsl --shutdown

&gt; wsl -l -v
  NAME      STATE           VERSION
* Ubuntu    Stopped         2
</code></pre><p>STATEがStoppedになっていれば大丈夫．ちなみに，VERSIONはWSL1上で動作しているのか，WSL2上で動作しているかが分かる．</p>
<p>続いて，WSLのデータを容量に余裕のある任意の場所にエクスポートする．これはいわばバックアップのようなもので，仮想ディスクファイルを移行しない場合でも実行できる．</p>
<pre><code>&gt; wsl --export Ubuntu T:\wsl\ubuntu\Ubuntu.tar
</code></pre><p>結果，<code>T:\wsl\ubuntu\</code>にバックアップファイル<code>Ubuntu.tar</code>が作成される（念のため，事前に<code>mkdir t:\wsl\ubuntu</code>を実行していた）．tarでちょっとだけ圧縮されているのか，このファイルは52.6GBであった．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/tar.jpg" alt="バックアップ"></p>
<p>続いて，WSLのデータの登録解除および削除を行う．</p>
<pre><code>&gt; wsl --unregister Ubuntu

&gt; wsl -l -v
Linux 用 Windows サブシステムには、ディストリビューションがインストールされていません。
ディストリビューションは Microsoft Store にアクセスしてインストールすることができます:
https://aka.ms/wslstore
</code></pre><p>これでUbuntuの登録が解除されたことがわかった．また，仮想ディスクファイルも同時に削除されていることが分かる．</p>
<table>
<thead>
<tr>
<th><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/folder.jpg" alt="解除前"></th>
<th><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/folder2.jpg" alt="解除後"></th>
</tr>
</thead>
<tbody>
<tr>
<td>解除前</td>
<td>解除後</td>
</tr>
</tbody>
</table>
<p>さて，ここからが本日の大一番である，WSLへの再インポートだ．とはいえこれも一つのコマンドで実行することができて便利だ．</p>
<pre><code>&gt; wsl --import Ubuntu T:\wsl\ubuntu T:\wsl\ubuntu\Ubuntu.tar

&gt; wsl -l -v
  NAME      STATE           VERSION
* Ubuntu    Stopped         2
</code></pre><p>先ほどと同様に，これと同時に仮想ディスクファイルがTドライブに作成されている．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/t-drive.jpg" alt="Tドライブに移動後"></p>
<p>ここまでくれば，基本的にほとんど元通りの操作ができるようになる．一方で，そのまま起動してもデフォルトでrootを使わなければならなくなり，<code>su offnaria</code>といったひと手間が必要になる．</p>
<p>そこで，<code>wsl.exe</code>に適切な引数を与えて起動するショートカットを作成し，これまでのようにoffnariaとしてログインできるようにする．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/shortcut.jpg" alt="ショートカットに引数を与える"></p>
<p>リンク先として<code>%windir%\System32\wsl.exe -u offnaria -d Ubuntu</code>を入力する．<code>-u</code>オプションはユーザ名を，<code>-d</code>オプションはインスタンス名を指定する（<code>%windir%\System32</code>にパスが通っているならこの部分は不要かも）．</p>
<p>作業フォルダーはログイン直後のカレントディレクトリを指定する．WSLのディレクトリ群はWindows上では<code>\\wsl$</code>以下に存在しているため，そこから辿ったホームディレクトリを指定すればよい．僕の場合は<code>\\wsl$\Ubuntu\home\offnaria</code>であった．</p>
<h4 id="結果">結果</h4>
<p>これで，今までのように起動直後から一般ユーザで作業を行うことができる．</p>
<p><img src="https://offnaria.github.io/portfolio/img/home/c-drive-panpan/complete.jpg" alt="作業完了"></p>
<h4 id="問題点">問題点</h4>
<p>使っていたファイル等はこれまで通り存在しており，今のところ破損も見られない．しかしながら，一部のアプリケーションが動作しないといったことが起こっていた．</p>
<p>例えば，このサイトを作成している<a href="https://gohugo.io/">hugo</a>もその一つで，ターミナルに<code>hugo</code>と入力しても<code>not found</code>が返されてしまった．再インストールのために<code>brew install hugo</code>を試したが，今度は<a href="https://docs.brew.sh/Homebrew-on-Linux">Homebrew</a>も見つからなかった．幸いにしてHomebrewの再インストールで上手く動くようになったが，他にもこのようなアプリケーションがあるのではないかと心配である．</p>
<p>また，VSCodeを直接WSLに繋いだ際にrootでログインされてしまうので，例のごとく<code>su offnaria</code>を実行せねばならない．</p>
         
      </div>
    </div>
  </div>
</div>

          </div>
      </div>
  </div>
  <script src="https://offnaria.github.io/portfolio/js/jquery.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/bootstrap.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/jquery.cookie.js"> </script>
<script src="https://offnaria.github.io/portfolio/js/ekko-lightbox.js"></script>
<script src="https://offnaria.github.io/portfolio/js/jquery.scrollTo.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/masonry.pkgd.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/imagesloaded.pkgd.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/owl.carousel.min.js"></script>
<script src="https://offnaria.github.io/portfolio/js/front.js"></script>



</body>
</html>
